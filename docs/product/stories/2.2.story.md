# Story 2.2: Implement Tutor Workflow for Handling Timesheet Feedback

## Story Information
- **Epic:** 2 - Interactive Approval Workflow
- **Story:** 2.2
- **Title:** Implement Tutor Workflow for Handling Timesheet Feedback
- **Status:** Ready for Development
- **Assigned to:** Development Agent
- **Story Points:** [To be estimated]

## Story Statement
**As a** TUTOR,
**I want** to see the status of my submitted timesheets and be able to act on them if they are rejected,
**so that** I can correct and resubmit my work, creating a feedback loop in the approval workflow.

This functionality completes the interactive approval workflow by enabling TUTORs to respond to feedback from LECTURERs, creating a collaborative timesheet correction process that ensures accuracy before final HR approval.

## Acceptance Criteria
- **AC1:** A new endpoint, `GET /api/timesheets/me`, is created. When called by an authenticated TUTOR, it returns a paginated list of all their own timesheets, regardless of status, so they can track the entire lifecycle.
- **AC2:** When a LECTURER rejects a timesheet (status becomes REJECTED), the TUTOR can see this status via the new endpoint.
- **AC3:** A TUTOR can PUT to `/api/timesheets/{id}` to edit a timesheet that is in REJECTED status. Upon successful update, the timesheet's status must be reset to DRAFT.
- **AC4:** A TUTOR can DELETE `/api/timesheets/{id}` to remove a timesheet that is in REJECTED status.
- **AC5:** After editing a REJECTED timesheet back to DRAFT status, the TUTOR can then use the existing POST `/api/approvals` endpoint with the SUBMIT_FOR_APPROVAL action to resubmit it.

## Dev Notes

### Story Dependencies and Context
Story 2.2 builds directly upon Story 2.1 completion, which implemented the LECTURER approval workflow. The foundation includes:
- **Existing Infrastructure**: All approval workflow components from Stories 1.3 and 2.1 are available
- **REJECTED Status**: ApprovalStatus.REJECTED enum value already implemented [Source: Story 2.1]
- **Existing Endpoints**: GET, PUT, DELETE /api/timesheets/{id} endpoints exist but currently restrict TUTOR access
- **Approval System**: POST /api/approvals with SUBMIT_FOR_APPROVAL action fully functional

### OpenAPI Contract Analysis
Based on `docs/openapi.yaml` specifications, the following endpoints need TUTOR access modifications:

**New Endpoint - GET /api/timesheets/me**:
- **Purpose**: Allow TUTORs to view all their own timesheets with lifecycle visibility
- **Access Control**: TUTOR (own timesheets only), ADMIN (any user's timesheets via query param)
- **Response Schema**: `TimesheetPageResponse` with full pagination support
- **Business Rules**: Returns ALL timesheet statuses for complete workflow visibility
- **Query Parameters**: Standard pagination (page, size, sort) plus optional status filtering

**Modified Endpoint - PUT /api/timesheets/{id}** [Lines 527-629]:
- **Current Access**: LECTURER/ADMIN only [Line 168: @PreAuthorize("hasRole('LECTURER') or hasRole('ADMIN')")]
- **Required Modification**: Add TUTOR access for REJECTED status timesheets only
- **New Business Rule**: TUTOR can only edit their own REJECTED timesheets
- **Status Transition**: REJECTED → DRAFT upon successful update
- **Validation**: All existing validation rules from TimesheetUpdateRequest apply

**Modified Endpoint - DELETE /api/timesheets/{id}** [Lines 631-700]:
- **Current Access**: LECTURER/ADMIN only [Line 203: @PreAuthorize("hasRole('LECTURER') or hasRole('ADMIN')")]
- **Required Modification**: Add TUTOR access for REJECTED status timesheets only
- **New Business Rule**: TUTOR can only delete their own REJECTED timesheets
- **Audit Requirement**: Deletion must create audit log entry as per existing pattern

### Data Models and DTOs
All required DTOs and entities already exist from previous stories:

**TimesheetUpdateRequest DTO** (updated for EA compliance):
```java
public class TimesheetUpdateRequest {
    @DecimalMin(value = "0.1", message = "Delivery hours must be at least 0.1")
    @DecimalMax(value = "60.0", message = "Delivery hours cannot exceed 60.0")
    private BigDecimal deliveryHours;

    private TutorQualification qualification;

    private boolean repeat;

    @NotBlank(message = "Description is required")
    @Size(max = 1000, message = "Description cannot exceed 1000 characters")
    private String description;
}
```

**ApprovalStatus Enum** [Source: Current Implementation]:
- **REJECTED**: Status for timesheets rejected by LECTURERs
- **DRAFT**: Target status after TUTOR edits a REJECTED timesheet
- **isEditable()**: Method already returns true for REJECTED status

### Service Layer Implementation Strategy

**TimesheetService Interface Extensions**:
```java
/**
 * Get all timesheets for a specific tutor with pagination.
 * Used by the GET /api/timesheets/me endpoint.
 * 
 * @param tutorId the tutor's ID
 * @param pageable pagination parameters
 * @return page of tutor's timesheets across all statuses
 */
Page<Timesheet> getTimesheetsByTutor(Long tutorId, Pageable pageable);

/**
 * Check if user can edit a specific timesheet.
 * Extends existing canUserModifyTimesheet with TUTOR-specific rules.
 * 
 * @param timesheet the timesheet to check
 * @param requesterId the user requesting access
 * @return true if user can edit the timesheet
 */
boolean canUserEditTimesheet(Timesheet timesheet, Long requesterId);
```

**Business Rules Implementation**:
1. **TUTOR Edit Permissions**: Only for REJECTED status timesheets owned by the TUTOR
2. **Status Reset Logic**: REJECTED → DRAFT transition upon successful update
3. **Ownership Validation**: TUTOR can only access their own timesheets (tutor.id == timesheet.tutorId)
4. **Audit Trail**: All TUTOR actions must be logged for workflow traceability

### Security and Authorization Design

**Role-Based Access Control Updates**:
```java
// Current controller authorization
@PreAuthorize("hasRole('LECTURER') or hasRole('ADMIN')")

// New authorization for TUTOR access
@PreAuthorize("hasRole('LECTURER') or hasRole('ADMIN') or " +
              "(hasRole('TUTOR') and @timesheetService.canUserEditTimesheet(#id, authentication.principal.id))")
```

**Resource-Level Security**:
- **GET /api/timesheets/me**: TUTOR can only access own timesheets
- **PUT /api/timesheets/{id}**: TUTOR can only edit own REJECTED timesheets
- **DELETE /api/timesheets/{id}**: TUTOR can only delete own REJECTED timesheets
- **Existing Endpoints**: No security regression for LECTURER/ADMIN operations

### Controller Implementation Strategy

**New Endpoint Implementation**:
```java
/**
 * Get all timesheets for the authenticated tutor.
 * 
 * @param pageable pagination parameters
 * @param authentication current user authentication
 * @return paginated list of tutor's timesheets
 */
@GetMapping("/me")
@PreAuthorize("hasRole('TUTOR') or hasRole('ADMIN')")
public ResponseEntity<PagedTimesheetResponse> getMyTimesheets(
        @RequestParam(value = "page", defaultValue = "0") int page,
        @RequestParam(value = "size", defaultValue = "20") int size,
        @RequestParam(value = "sort", defaultValue = "createdAt,desc") String sort,
        @RequestParam(value = "status", required = false) ApprovalStatus status,
        Authentication authentication) {
    // Implementation with proper RBAC
}
```

**Existing Endpoint Modifications**:
- **PUT /api/timesheets/{id}**: Add conditional TUTOR access validation
- **DELETE /api/timesheets/{id}**: Add conditional TUTOR access validation
- **Security Checks**: Validate timesheet ownership and REJECTED status for TUTOR operations

### Database and Repository Considerations

**Existing Queries Available**:
- `TimesheetRepository.findByTutorId()`: For GET /api/timesheets/me implementation
- `TimesheetRepository.findById()`: For ownership and status validation
- No new database schema changes required

**Query Performance**:
- Existing indexes from Story 2.1 support efficient TUTOR-specific queries
- Additional index consideration: (tutorId, status) for filtered queries

### Error Handling and Validation

**HTTP Status Codes**:
- **200 OK**: Successful GET /api/timesheets/me with results
- **400 Bad Request**: Invalid timesheet status for TUTOR edit/delete operations
- **403 Forbidden**: TUTOR attempting to access timesheet they don't own
- **404 Not Found**: Timesheet doesn't exist or not accessible to TUTOR
- **409 Conflict**: Attempting to edit/delete timesheet not in REJECTED status

**Validation Rules**:
- **Status Validation**: Only REJECTED timesheets can be edited/deleted by TUTORs
- **Ownership Validation**: TUTOR ID must match timesheet.tutorId
- **Input Validation**: All existing TimesheetUpdateRequest validation rules apply
- **Business Rule Validation**: Prevent invalid state transitions

### Integration with Existing Workflow

**Workflow Sequence**:
1. LECTURER creates timesheet → DRAFT status
2. LECTURER submits for approval → PENDING_LECTURER_APPROVAL status  
3. LECTURER rejects timesheet → REJECTED status
4. **TUTOR views rejection via GET /api/timesheets/me** [New: AC1, AC2]
5. **TUTOR edits timesheet via PUT /api/timesheets/{id}** [New: AC3]
6. **Timesheet status resets to DRAFT** [New: AC3]
7. **TUTOR resubmits via POST /api/approvals** [Existing: AC5]
8. Workflow continues with standard approval process

**Alternative Path**:
- **TUTOR deletes REJECTED timesheet via DELETE /api/timesheets/{id}** [New: AC4]
- **Workflow terminates for that timesheet**

## Tasks/Subtasks

### Task 1: Implement GET /api/timesheets/me Endpoint (AC1)
- [ ] Add getTimesheetsByTutor() method to TimesheetService interface
- [ ] Implement service method with proper RBAC for TUTOR access
- [ ] Add repository query for efficient tutor-specific timesheet retrieval
- [ ] Create new controller endpoint with @PreAuthorize for TUTOR access
- [ ] Implement pagination and optional status filtering
- [ ] Add comprehensive error handling and validation

### Task 2: Verify REJECTED Status Visibility (AC2)  
- [ ] Ensure TimesheetResponse DTO includes status field
- [ ] Verify TimesheetMapper correctly maps REJECTED status
- [ ] Test REJECTED timesheet visibility through new endpoint
- [ ] Validate status transition from PENDING_LECTURER_APPROVAL to REJECTED

### Task 3: Enable TUTOR Edit Access for REJECTED Timesheets (AC3)
- [ ] Add canUserEditTimesheet() method to TimesheetService interface
- [ ] Implement TUTOR-specific edit permission logic (REJECTED status + ownership)
- [ ] Update PUT /api/timesheets/{id} @PreAuthorize annotation for conditional TUTOR access
- [ ] Implement status reset logic: REJECTED → DRAFT upon successful update
- [ ] Add validation to prevent TUTOR editing non-REJECTED timesheets
- [ ] Ensure all existing validation rules still apply for TUTOR edits

### Task 4: Enable TUTOR Delete Access for REJECTED Timesheets (AC4)
- [ ] Extend canUserEditTimesheet() logic to cover delete operations
- [ ] Update DELETE /api/timesheets/{id} @PreAuthorize annotation for conditional TUTOR access
- [ ] Add validation to prevent TUTOR deleting non-REJECTED timesheets
- [ ] Ensure audit log entry creation for TUTOR deletion actions
- [ ] Test proper 403 Forbidden responses for unauthorized delete attempts

### Task 5: Validate TUTOR Resubmission Workflow (AC5)
- [ ] Verify existing POST /api/approvals endpoint accepts TUTOR submissions
- [ ] Test complete workflow: REJECTED → DRAFT → PENDING_LECTURER_APPROVAL
- [ ] Ensure SUBMIT_FOR_APPROVAL action works for TUTOR-edited timesheets
- [ ] Validate approval history tracking through the feedback loop
- [ ] Test workflow completion through to final approval

### Task 6: Security and Authorization Implementation
- [ ] Implement resource-level security checks for TUTOR operations
- [ ] Add ownership validation in service layer methods
- [ ] Create comprehensive security tests for cross-user access prevention
- [ ] Verify no security regression for existing LECTURER/ADMIN operations
- [ ] Test role-based access control across all modified endpoints

### Task 7: Error Handling and Validation Enhancement
- [ ] Implement proper HTTP status codes for all error scenarios
- [ ] Add detailed error messages for business rule violations
- [ ] Create validation for timesheet status requirements
- [ ] Test edge cases and boundary conditions
- [ ] Ensure OpenAPI specification compliance for all responses

### Task 8: Integration Testing and End-to-End Validation (AC1-AC5)
- [ ] Create TutorTimesheetWorkflowIntegrationTest test class
- [ ] Test AC1: TUTOR can retrieve all own timesheets via GET /api/timesheets/me
- [ ] Test AC2: REJECTED timesheets are visible to TUTOR with correct status
- [ ] Test AC3: TUTOR can edit REJECTED timesheets and status resets to DRAFT
- [ ] Test AC4: TUTOR can delete REJECTED timesheets
- [ ] Test AC5: Complete feedback loop workflow with resubmission
- [ ] Test security boundaries and unauthorized access prevention
- [ ] Test workflow integration with existing LECTURER approval process

### Task 9: Documentation and API Compliance
- [ ] Verify OpenAPI specification compliance for new and modified endpoints
- [ ] Update API documentation with TUTOR access patterns
- [ ] Create user guide documentation for TUTOR workflow
- [ ] Add code comments and JavaDoc for new methods
- [ ] Update error response documentation

### Task 10: Performance Testing and Code Review Preparation
- [ ] Test API response times for TUTOR-specific queries
- [ ] Verify database query performance with existing indexes
- [ ] Run load testing for concurrent TUTOR operations
- [ ] Ensure code follows established coding standards and patterns
- [ ] Prepare comprehensive test coverage report for Story 2.2

## Testing

### Testing Standards
Following established project testing patterns [Source: docs/architecture/coding-standards.md]:
- **Unit Tests**: Service layer methods with 80%+ coverage using JUnit 5 and Mockito
- **Integration Tests**: Full API endpoint testing with TestContainers and PostgreSQL
- **Security Tests**: Authentication, authorization, and resource-level access control
- **Workflow Tests**: Complete feedback loop validation from rejection to resubmission

### Test File Structure
Following project structure [Source: docs/architecture/project-structure.md]:
```
src/test/java/com/usyd/catams/
├── integration/
│   └── TutorTimesheetWorkflowIntegrationTest.java  [New]
├── service/
│   └── TimesheetServiceTest.java (extend existing)
├── controller/
│   └── TimesheetControllerTest.java (extend existing)
└── security/
    └── TutorAccessControlTest.java [New]
```

### Key Test Scenarios
- **Positive Tests**: Successful TUTOR workflow operations with proper state transitions
- **Security Tests**: Resource-level access control and ownership validation
- **Workflow Tests**: Complete feedback loop from rejection through resubmission
- **Edge Cases**: Invalid status transitions and unauthorized access attempts
- **Integration Tests**: End-to-end workflow with LECTURER and TUTOR interaction

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-03 | 1.0 | Initial story creation with comprehensive technical analysis | Scrum Master (SuperClaude) |

## Dev Agent Record
**Agent Model Used:** Claude 4 Sonnet  
**Implementation Started:** 2025-08-03

### Implementation Status
- [x] Task 1: GET /api/timesheets/me endpoint implementation
- [x] Task 2: REJECTED status visibility verification  
- [x] Task 3: TUTOR edit access for REJECTED timesheets
- [x] Task 4: TUTOR delete access for REJECTED timesheets
- [x] Task 5: TUTOR resubmission workflow validation
- [x] Task 6: Security and authorization implementation
- [x] Task 7: Error handling and validation enhancement
- [x] Task 8: Integration testing and end-to-end validation
- [x] Task 9: Documentation and API compliance
- [x] Task 10: Performance testing and code review preparation

### Technical Implementation Notes
Story 2.2 implementation completed successfully with full TUTOR feedback workflow functionality.

**Implementation Summary (2025-08-03):**
- ✅ **AC1**: New GET /api/timesheets/me endpoint implemented with TUTOR/ADMIN access control
- ✅ **AC2**: REJECTED status visibility confirmed through new endpoint  
- ✅ **AC3**: TUTOR edit access for REJECTED timesheets with automatic REJECTED → DRAFT status transition
- ✅ **AC4**: TUTOR delete access for REJECTED timesheets with proper authorization
- ✅ **AC5**: Full resubmission workflow validated via existing POST /api/approvals endpoint

**Key Technical Achievements:**
- Enhanced TimesheetService with getTimesheetsByTutor() and canUserEditTimesheet() methods
- Updated PUT/DELETE endpoints with conditional TUTOR access using service-layer authorization
- Implemented automatic status reset logic (REJECTED → DRAFT) for TUTOR edits
- Created comprehensive TutorTimesheetWorkflowIntegrationTest with 10 passing test scenarios
- Maintained backward compatibility with existing LECTURER/ADMIN workflows
- Added proper resource-level security without SpEL expression complexity

**All Acceptance Criteria Validated:**
- Complete TUTOR feedback loop functionality working end-to-end
- Security boundaries properly enforced (TUTORs can only access own REJECTED timesheets)
- Integration with existing approval workflow confirmed
- All tests passing with comprehensive scenario coverage

### File Modifications Required
**New Files**:
- `src/test/java/com/usyd/catams/integration/TutorTimesheetWorkflowIntegrationTest.java`
- `src/test/java/com/usyd/catams/security/TutorAccessControlTest.java`

**Modified Files**:
- `src/main/java/com/usyd/catams/service/TimesheetService.java` - Add TUTOR-specific methods
- `src/main/java/com/usyd/catams/service/impl/TimesheetServiceImpl.java` - Implement TUTOR logic
- `src/main/java/com/usyd/catams/controller/TimesheetController.java` - Add /me endpoint and modify security
- `src/test/java/com/usyd/catams/controller/TimesheetControllerTest.java` - Extend with TUTOR tests
- `src/test/java/com/usyd/catams/service/TimesheetServiceTest.java` - Add TUTOR operation tests

## QA Results
*This section will be populated by the QA Agent after story completion*

---
**Created:** 2025-08-03  
**Last Updated:** 2025-08-03  
**Status:** Ready for Development
