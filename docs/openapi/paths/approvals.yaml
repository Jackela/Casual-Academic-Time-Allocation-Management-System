post:
  tags:
    - Approvals
  summary: Perform approval action
  description: |
    Perform an approval action on a timesheet (approve, reject, request modification, final approval).
    
    **Access rules (SSOT aligned)**:
    - **TUTOR**: Can APPROVE / REJECT / REQUEST_MODIFICATION on `PENDING_TUTOR_REVIEW` (owns the timesheet)
    - **LECTURER**: Can FINAL_APPROVAL / REJECT on `APPROVED_BY_TUTOR` (their courses)
    - **HR/ADMIN**: Can HR_APPROVE / HR_REJECT on `APPROVED_BY_LECTURER_AND_TUTOR`; ADMIN may perform any action
    
    **Workflow states (enhanced path)**:
    - DRAFT -> PENDING_TUTOR_REVIEW (SUBMIT_FOR_APPROVAL)
    - PENDING_TUTOR_REVIEW -> APPROVED_BY_TUTOR (APPROVE) | REJECTED (REJECT) | MODIFICATION_REQUESTED (REQUEST_MODIFICATION)
    - APPROVED_BY_TUTOR -> APPROVED_BY_LECTURER_AND_TUTOR (FINAL_APPROVAL) | REJECTED (REJECT by LECTURER)
    - APPROVED_BY_LECTURER_AND_TUTOR -> FINAL_APPROVED (HR_APPROVE) | REJECTED (HR_REJECT)
  operationId: performApprovalAction
  security:
    - bearerAuth: []
  requestBody:
    required: true
    content:
      application/json:
        schema:
          $ref: '../schemas/approvals.yaml#/ApprovalActionRequest'
        examples:
          approve_timesheet:
            summary: Approve timesheet
            value:
              timesheetId: 789
              action: "APPROVE"
              comment: "Approved - hours and description look correct"
          reject_timesheet:
            summary: Reject timesheet
            value:
              timesheetId: 789
              action: "REJECT"
              comment: "Rejected - hours seem excessive for the described work"
          request_modification:
            summary: Request modification
            value:
              timesheetId: 789
              action: "REQUEST_MODIFICATION"
              comment: "Please provide more detailed description of the tutorial work"
  responses:
    '200':
      description: Approval action completed successfully
      content:
        application/json:
          schema:
            $ref: '../schemas/approvals.yaml#/ApprovalActionResponse'
          examples:
            approval_success:
              summary: Successful approval action
              value:
                timesheetId: 789
                action: "FINAL_APPROVAL"
                newStatus: "APPROVED_BY_LECTURER_AND_TUTOR"
                approverId: 999
                approverName: "Dr. Jane Smith"
                comment: "Final academic approval"
                timestamp: "2025-08-01T16:30:00Z"
                nextSteps:
                  - "Timesheet is ready for HR final review"
    '400':
      description: Invalid approval action or business rule violation
      content:
        application/json:
          schema:
            $ref: '../schemas/errors.yaml#/ErrorResponse'
          examples:
            invalid_transition:
              summary: Invalid state transition
              value:
                timestamp: "2025-08-01T10:15:30.123Z"
                status: 400
                error: "INVALID_STATE_TRANSITION"
                message: "Cannot approve timesheet in current state: DRAFT"
                path: "/api/approvals"
    '401':
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '../schemas/errors.yaml#/ErrorResponse'
    '403':
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '../schemas/errors.yaml#/ErrorResponse'
          examples:
            not_authorized:
              summary: Not authorized for this timesheet
              value:
                timestamp: "2025-08-01T10:15:30.123Z"
                status: 403
                error: "ACCESS_DENIED"
                message: "You are not authorized to approve this timesheet"
                path: "/api/approvals"
    '404':
      description: Timesheet not found
      content:
        application/json:
          schema:
            $ref: '../schemas/errors.yaml#/ErrorResponse'
    '500':
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '../schemas/errors.yaml#/ErrorResponse'

