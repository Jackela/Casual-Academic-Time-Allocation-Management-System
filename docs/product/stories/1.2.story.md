# Story 1.2: Implement Core Timesheet CRUD Functionality (Create and Read)

## Story Information
- **Epic:** 1 - Core Timesheet Management Functionality
- **Story:** 1.2
- **Title:** Implement Core Timesheet CRUD Functionality (Create and Read)
- **Status:** Ready for Development
- **Assigned to:** [To be assigned]
- **Story Points:** [To be estimated]

## Story Statement
As the core functionality of the CATAMS system, we need to implement timesheet creation and reading functionality, enabling lecturers to create timesheet records for tutors, and allowing tutors and administrators to view relevant timesheet information.

This functionality must strictly follow the API specifications defined in `openapi.yaml`, implementing the `POST /api/timesheets` and `GET /api/timesheets` endpoints.

## Acceptance Criteria
- [ ] **AC1:** As a LECTURER, I can create timesheet records for TUTORs via POST /api/timesheets, including all required fields (tutorId, courseId, weekStartDate, hours, hourlyRate, description)
- [ ] **AC2:** As a TUTOR, I can view all my timesheet records via GET /api/timesheets, returning paginated results
- [ ] **AC3:** As an ADMIN, I can view all users' timesheet records via GET /api/timesheets, with filtering support by tutorId and courseId
- [ ] **AC4:** When requesting non-existent timesheet records, the system returns 404 error with standard error response format
- [ ] **AC5:** All API responses must comply with schema validation requirements defined in OpenAPI specifications

## Dev Notes

### Previous Story Dependencies
This story depends on the completion of Story 1.1, requiring the following prerequisites:
- User authentication and authorization system implemented
- JWT Token verification mechanism available
- RBAC permission control configured
- Basic error handling mechanism established

### OpenAPI Contract Compliance
Must strictly follow the API specifications in `docs/openapi.yaml`:

**POST /api/timesheets** [Lines 570-652]:
- Request body schema: `TimesheetCreateRequest`
- Success response: `201 Created` with `TimesheetResponse`
- Permission requirement: LECTURER role only
- Business rules: weekStartDate must be Monday, hours 0.1-40 range, hourlyRate 10-200 range

**GET /api/timesheets** [Lines 654-749]:
- Query parameters: tutorId, courseId, page, size, sort
- Success response: `200 OK` with `PagedTimesheetResponse`
- Permission rules: TUTOR can only view their own, ADMIN can view all
- Pagination support: default page=0, size=20

### Data Models
According to OpenAPI specifications, the following core data models need to be implemented:

**Timesheet Entity** [Schema Lines 1200-1260]:
```java
public class Timesheet {
    private Long id;                    // Primary key
    private Long tutorId;               // Tutor ID (FK to User)
    private Long courseId;              // Course ID (FK to Course)
    private LocalDate weekStartDate;    // Week start date (must be Monday)
    private BigDecimal hours;           // Hours worked (0.1–40)
    private BigDecimal hourlyRate;      // Hourly rate (10–200)
    private String description;         // Work description
    private ApprovalStatus status;      // Approval status (default DRAFT)
    private LocalDateTime createdAt;    // Created timestamp
    private LocalDateTime updatedAt;    // Updated timestamp
    private Long createdBy;             // Creator (LECTURER)
}
```

**Course Entity** [Schema Lines 1324-1380]:
```java
public class Course {
    private Long id;
    private String code;              
    private String name;              
    private String semester;          
    private Long lecturerId;          // Lecturer responsible for the course
    private BigDecimal budgetAllocated; 
    private BigDecimal budgetUsed;    
    private Boolean isActive;         
}
```

**DTOs Required**:
- `TimesheetCreateRequest` - Create request
- `TimesheetResponse` - Single timesheet response
- `PagedTimesheetResponse` - Paginated response

### API Specifications
Detailed requirements per OpenAPI contract:

**POST /api/timesheets**:
- Content-Type: application/json
- Authorization: Bearer JWT (LECTURER role required)
- Business validation:
  - tutorId must reference a valid TUTOR
  - courseId must reference a valid and active course
  - LECTURER must be the owner of the course
  - weekStartDate must be a Monday
  - TUTOR + Course + WeekStartDate combination must be unique

**GET /api/timesheets**:
- Supports query params: tutorId, courseId, page, size, sort
- Permission rules: TUTOR can only query tutorId=self; ADMIN can view all
- Sorting: default createdAt DESC

### Component Specifications
No specific frontend component requirements; focus on backend API implementation.

### File Locations
Based on Spring Boot structure and modular design:

**Entities & Enums**:
- `src/main/java/com/usyd/catams/entity/Timesheet.java`
- `src/main/java/com/usyd/catams/entity/Course.java`
- `src/main/java/com/usyd/catams/enums/ApprovalStatus.java`

**Repository layer**:
- `src/main/java/com/usyd/catams/repository/TimesheetRepository.java`
- `src/main/java/com/usyd/catams/repository/CourseRepository.java`

**Service layer**:
- `src/main/java/com/usyd/catams/service/TimesheetService.java`
- `src/main/java/com/usyd/catams/service/impl/TimesheetServiceImpl.java`

**Controller layer**:
- `src/main/java/com/usyd/catams/controller/TimesheetController.java`

**DTOs**:
- `src/main/java/com/usyd/catams/dto/request/TimesheetCreateRequest.java`
- `src/main/java/com/usyd/catams/dto/response/TimesheetResponse.java`
- `src/main/java/com/usyd/catams/dto/response/PagedTimesheetResponse.java`

**Test files**:
- `src/test/java/com/usyd/catams/integration/TimesheetIntegrationTest.java`
- `src/test/java/com/usyd/catams/service/TimesheetServiceTest.java`

### Testing Requirements
Required coverage:

**Integration tests** (TimesheetIntegrationTest.java):
- AC1: LECTURER creates timesheet successfully
- AC2: TUTOR queries own timesheets
- AC3: ADMIN queries all timesheets with filtering
- AC4: Querying a non‑existent record returns 404
- AC5: Schema validation tests
- Permission tests: non‑LECTURER cannot create; TUTOR cannot view others
- Business rules: duplicate records, invalid dates, out‑of‑range values

**Unit tests** (TimesheetServiceTest.java):
- Service business logic
- Data validation logic
- Permission checks

### Technical Constraints
**Tech stack consistency** (inherits from Story 1.1):
- Java with Spring Boot 3+
- Spring Security with JWT
- Spring Data JPA with PostgreSQL
- Jakarta Bean Validation

**Performance requirements** [Source: docs/policy/ea-compliance-plan.md#5.1]:
- API response time < 500ms (95% of requests)
- Pagination supports large datasets (10,000+ records)
- DB query optimization (indexing strategy)

**Security requirements**:
- All APIs require JWT authentication
- Role‑based access control (RBAC)
- Input validation and SQL injection protection
- Audit logging for sensitive operations

## Tasks/Subtasks

### Task 1: Database Schema and Entities (AC1, AC2, AC3)
1.1. Create Timesheet entity per OpenAPI schema
1.2. Create Course entity including budget fields
1.3. Update ApprovalStatus enum with timesheet states
1.4. Configure JPA relationships and DB constraints
1.5. Add database migration scripts

### Task 2: Repository Layer Implementation (AC2, AC3)
2.1. Create TimesheetRepository interface
2.2. Implement custom queries (findByTutorId, findByCourseId)
2.3. Create CourseRepository interface
2.4. Implement pagination and sorting queries
2.5. Add repository unit tests

### Task 3: Service Layer Implementation (AC1, AC2, AC3, AC4)
3.1. Create TimesheetService interface
3.2. Implement TimesheetServiceImpl
3.3. Implement createTimesheet with business validation
3.4. Implement getTimesheets with permissions and filtering
3.5. Implement rules (date checks, duplicate checks, permission checks)
3.6. Add service unit tests

### Task 4: DTO and Request/Response Objects (AC5)
4.1. Create TimesheetCreateRequest DTO with validation annotations
4.2. Create TimesheetResponse DTO
4.3. Create PagedTimesheetResponse DTO
4.4. Configure JSON serialization/deserialization
4.5. Implement entity↔DTO mapping

### Task 5: REST API Controller Implementation (AC1, AC2, AC3, AC4)
5.1. Create TimesheetController
5.2. Implement POST /api/timesheets with permission checks
5.3. Implement GET /api/timesheets with filters and pagination
5.4. Implement permission checks and business exception handling
5.5. Add Swagger/OpenAPI annotations

### Task 6: Validation and Error Handling (AC4, AC5)
6.1. Implement request validation (Jakarta Bean Validation)
6.2. Implement business rules (Monday weekStartDate, numeric ranges)
6.3. Extend GlobalExceptionHandler for timesheet exceptions
6.4. Ensure error response format matches OpenAPI

### Task 7: Security and Authorization (AC1, AC2, AC3)
7.1. Configure method‑level security (@PreAuthorize)
7.2. Enforce LECTURER ownership checks
7.3. Enforce TUTOR self‑access only
7.4. Enforce ADMIN full access
7.5. Add security integration tests

### Task 8: Integration Testing and End-to-End Validation (AC1-AC5)
8.1. Create TimesheetIntegrationTest
8.2. Test full LECTURER create flow
8.3. Test TUTOR self query
8.4. Test ADMIN query and filters
8.5. Test error scenarios and exception handling
8.6. Validate OpenAPI schema compliance
8.7. Validate all acceptance criteria

### Task 9: Performance Optimization and Database Indexing
9.1. Create DB indexes (tutorId, courseId, weekStartDate)
9.2. Optimize pagination performance
9.3. Implement query caching (if applicable)
9.4. Performance tests and benchmarks

### Task 10: Documentation and API Testing
10.1. Update examples in OpenAPI docs
10.2. Create API collections (Postman/Insomnia)
10.3. Write API usage guide
10.4. Validate API responses vs OpenAPI

## Project Structure Notes
This story continues the modular‑monolith approach. Place new code in appropriate packages and follow Spring Boot best practices and existing project style conventions.

## Definition of Done
- [ ] All acceptance criteria pass
- [ ] Code review approved
- [ ] Unit test coverage > 80%
- [ ] Integration tests pass
- [ ] API docs updated and validated
- [ ] Performance tests meet target (< 500ms response)
- [ ] Security tests pass (permission checks)
- [ ] OpenAPI contract fully compliant

## Dependencies
- **Prerequisites:** Story 1.1 (authentication & authorization) – completed
- **Data dependency:** Course model created (or developed in parallel)
- **Environment dependency:** PostgreSQL configured

## Risks and Mitigations
- **Risk:** Misinterpreting OpenAPI leads to incompatibility
  - **Mitigation:** Review openapi.yaml carefully; add contract tests
- **Risk:** Permission logic complexity and security holes
  - **Mitigation:** Comprehensive security tests, including bypass attempts
- **Risk:** Pagination performance issues
  - **Mitigation:** DB index optimization; benchmark queries
- **Risk:** Complex business rule validation
  - **Mitigation:** Detailed unit tests for boundary conditions

## Business Rules Summary
Per the OpenAPI and architecture docs, key business rules include:
1. Create permission: only LECTURER can create timesheets
2. Course ownership: LECTURER can create only within owned courses
3. View permission: TUTOR self‑only; ADMIN all
4. Date rule: weekStartDate must be Monday
5. Ranges: hours (0.1–40), hourlyRate (10–200)
6. Uniqueness: TUTOR + Course + WeekStartDate is unique
7. State: new timesheets start in DRAFT

---
**Created:** 2025-08-01  
**Last Updated:** 2025-08-01  
**Status:** Ready for Development
