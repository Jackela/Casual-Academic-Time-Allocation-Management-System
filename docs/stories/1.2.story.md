# Story 1.2: Implement Core Timesheet CRUD Functionality (Create and Read)

## Story Information
- **Epic:** 1 - Core Timesheet Management Functionality
- **Story:** 1.2
- **Title:** Implement Core Timesheet CRUD Functionality (Create and Read)
- **Status:** Ready for Development
- **Assigned to:** [To be assigned]
- **Story Points:** [To be estimated]

## Story Statement
As the core functionality of the CATAMS system, we need to implement timesheet creation and reading functionality, enabling lecturers to create timesheet records for tutors, and allowing tutors and administrators to view relevant timesheet information.

This functionality must strictly follow the API specifications defined in `openapi.yaml`, implementing the `POST /api/timesheets` and `GET /api/timesheets` endpoints.

## Acceptance Criteria
- [ ] **AC1:** As a LECTURER, I can create timesheet records for TUTORs via POST /api/timesheets, including all required fields (tutorId, courseId, weekStartDate, hours, hourlyRate, description)
- [ ] **AC2:** As a TUTOR, I can view all my timesheet records via GET /api/timesheets, returning paginated results
- [ ] **AC3:** As an ADMIN, I can view all users' timesheet records via GET /api/timesheets, with filtering support by tutorId and courseId
- [ ] **AC4:** When requesting non-existent timesheet records, the system returns 404 error with standard error response format
- [ ] **AC5:** All API responses must comply with schema validation requirements defined in OpenAPI specifications

## Dev Notes

### Previous Story Dependencies
This story depends on the completion of Story 1.1, requiring the following prerequisites:
- User authentication and authorization system implemented
- JWT Token verification mechanism available
- RBAC permission control configured
- Basic error handling mechanism established

### OpenAPI Contract Compliance
Must strictly follow the API specifications in `docs/openapi.yaml`:

**POST /api/timesheets** [Lines 570-652]:
- Request body schema: `TimesheetCreateRequest`
- Success response: `201 Created` with `TimesheetResponse`
- Permission requirement: LECTURER role only
- Business rules: weekStartDate must be Monday, hours 0.1-40 range, hourlyRate 10-200 range

**GET /api/timesheets** [Lines 654-749]:
- Query parameters: tutorId, courseId, page, size, sort
- Success response: `200 OK` with `PagedTimesheetResponse`
- Permission rules: TUTOR can only view their own, ADMIN can view all
- Pagination support: default page=0, size=20

### Data Models
According to OpenAPI specifications, the following core data models need to be implemented:

**Timesheet Entity** [Schema Lines 1200-1260]:
```java
public class Timesheet {
    private Long id;                    // 主键
    private Long tutorId;              // 助教ID (外键到User)
    private Long courseId;             // 课程ID (外键到Course) 
    private LocalDate weekStartDate;   // 工作周开始日期(必须是星期一)
    private BigDecimal hours;          // 工作小时数 (0.1-40)
    private BigDecimal hourlyRate;     // 小时费率 (10-200)
    private String description;        // 工作描述
    private ApprovalStatus status;     // 审批状态 (默认DRAFT)
    private LocalDateTime createdAt;   // 创建时间
    private LocalDateTime updatedAt;   // 更新时间
    private Long createdBy;           // 创建者ID (LECTURER)
}
```

**Course Entity** [Schema Lines 1324-1380]:
```java
public class Course {
    private Long id;
    private String code;              
    private String name;              
    private String semester;          
    private Long lecturerId;          // 课程负责讲师
    private BigDecimal budgetAllocated; 
    private BigDecimal budgetUsed;    
    private Boolean isActive;         
}
```

**DTOs Required**:
- `TimesheetCreateRequest` - 创建请求
- `TimesheetResponse` - 单个工时记录响应
- `PagedTimesheetResponse` - 分页查询响应

### API Specifications
基于OpenAPI规范的详细API实现要求：

**POST /api/timesheets**:
- Content-Type: application/json
- Authorization: Bearer JWT (LECTURER role required)
- 业务验证: 
  - tutorId必须是有效的TUTOR用户
  - courseId必须是有效且活跃的课程
  - LECTURER必须是该课程的负责人
  - weekStartDate必须是星期一
  - 同一TUTOR+Course+WeekStartDate组合不能重复

**GET /api/timesheets**:
- 支持查询参数: tutorId, courseId, page, size, sort
- 权限控制: TUTOR只能查询tutorId=自己ID，ADMIN无限制
- 排序支持: 默认按createdAt降序

### Component Specifications
无特定前端组件要求，专注于后端API实现。

### File Locations
基于Spring Boot项目结构和模块化设计：

**实体和枚举**:
- `src/main/java/com/usyd/catams/entity/Timesheet.java`
- `src/main/java/com/usyd/catams/entity/Course.java`
- `src/main/java/com/usyd/catams/enums/ApprovalStatus.java`

**数据访问层**:
- `src/main/java/com/usyd/catams/repository/TimesheetRepository.java`
- `src/main/java/com/usyd/catams/repository/CourseRepository.java`

**服务层**:
- `src/main/java/com/usyd/catams/service/TimesheetService.java`
- `src/main/java/com/usyd/catams/service/impl/TimesheetServiceImpl.java`

**控制器层**:
- `src/main/java/com/usyd/catams/controller/TimesheetController.java`

**DTO类**:
- `src/main/java/com/usyd/catams/dto/request/TimesheetCreateRequest.java`
- `src/main/java/com/usyd/catams/dto/response/TimesheetResponse.java`
- `src/main/java/com/usyd/catams/dto/response/PagedTimesheetResponse.java`

**测试文件**:
- `src/test/java/com/usyd/catams/integration/TimesheetIntegrationTest.java`
- `src/test/java/com/usyd/catams/service/TimesheetServiceTest.java`

### Testing Requirements
需要实现以下测试覆盖：

**集成测试** (TimesheetIntegrationTest.java):
- AC1: LECTURER创建工时记录成功场景
- AC2: TUTOR查询自己工时记录
- AC3: ADMIN查询所有工时记录并筛选
- AC4: 查询不存在记录返回404
- AC5: Schema验证测试
- 权限测试: 非LECTURER无法创建，TUTOR无法查看他人记录
- 业务规则验证: 重复记录、无效日期、超范围数值

**单元测试** (TimesheetServiceTest.java):
- 服务层业务逻辑测试
- 数据验证逻辑测试
- 权限检查逻辑测试

### Technical Constraints
**技术栈保持一致** (继承自Story 1.1):
- Java with Spring Boot 3+
- Spring Security with JWT认证
- Spring Data JPA with PostgreSQL
- Jakarta Bean Validation

**性能要求** [Source: prd-v0.2.md#5.1]:
- API响应时间 < 500ms (95%的请求)
- 分页查询支持大数据集 (10,000+ 记录)
- 数据库查询优化 (索引策略)

**安全要求**:
- 所有API必须通过JWT认证
- 基于角色的访问控制 (RBAC)
- 输入验证和SQL注入防护
- 敏感数据记录审计日志

## Tasks/Subtasks

### Task 1: Database Schema and Entities (AC1, AC2, AC3)
1.1. 创建Timesheet实体类，遵循OpenAPI schema定义
1.2. 创建Course实体类，包含预算管理字段
1.3. 更新ApprovalStatus枚举，添加工时相关状态
1.4. 配置JPA关系和数据库约束
1.5. 创建数据库migration脚本

### Task 2: Repository Layer Implementation (AC2, AC3)
2.1. 创建TimesheetRepository接口
2.2. 实现自定义查询方法 (findByTutorId, findByCourseId)
2.3. 创建CourseRepository接口
2.4. 实现分页和排序查询方法
2.5. 编写Repository层单元测试

### Task 3: Service Layer Implementation (AC1, AC2, AC3, AC4)
3.1. 创建TimesheetService接口
3.2. 实现TimesheetServiceImpl服务类
3.3. 实现createTimesheet方法，包含业务验证
3.4. 实现getTimesheets方法，支持权限控制和筛选
3.5. 实现业务规则验证 (日期、重复检查、权限验证)
3.6. 编写Service层单元测试

### Task 4: DTO and Request/Response Objects (AC5)
4.1. 创建TimesheetCreateRequest DTO，包含验证注解
4.2. 创建TimesheetResponse DTO
4.3. 创建PagedTimesheetResponse DTO
4.4. 配置JSON序列化和反序列化
4.5. 实现实体与DTO的映射逻辑

### Task 5: REST API Controller Implementation (AC1, AC2, AC3, AC4)
5.1. 创建TimesheetController类
5.2. 实现POST /api/timesheets端点，包含权限控制
5.3. 实现GET /api/timesheets端点，支持查询参数和分页
5.4. 实现权限检查和业务异常处理
5.5. 配置Swagger/OpenAPI注解

### Task 6: Validation and Error Handling (AC4, AC5)
6.1. 实现请求参数验证 (Jakarta Bean Validation)
6.2. 实现业务规则验证 (周一日期、数值范围等)
6.3. 扩展GlobalExceptionHandler，处理工时相关异常
6.4. 确保错误响应格式符合OpenAPI规范

### Task 7: Security and Authorization (AC1, AC2, AC3)
7.1. 配置方法级安全注解 (@PreAuthorize)
7.2. 实现LECTURER权限检查 (只能为自己负责的课程创建工时)
7.3. 实现TUTOR权限检查 (只能查看自己的工时记录)
7.4. 实现ADMIN全权限访问
7.5. 编写安全相关的集成测试

### Task 8: Integration Testing and End-to-End Validation (AC1-AC5)
8.1. 创建TimesheetIntegrationTest测试类
8.2. 测试LECTURER创建工时记录的完整流程
8.3. 测试TUTOR查询自己工时记录
8.4. 测试ADMIN查询和筛选功能
8.5. 测试错误场景和异常处理
8.6. 验证所有OpenAPI schema规范
8.7. 验证所有验收标准

### Task 9: Performance Optimization and Database Indexing
9.1. 创建数据库索引 (tutorId, courseId, weekStartDate)
9.2. 优化分页查询性能
9.3. 实现查询缓存策略 (如适用)
9.4. 性能测试和基准测试

### Task 10: Documentation and API Testing
10.1. 更新OpenAPI文档中的示例
10.2. 创建API测试集合 (Postman/Insomnia)
10.3. 编写API使用说明文档
10.4. 验证API响应与OpenAPI规范的一致性

## Project Structure Notes
该故事将继续遵循模块化单体架构，所有新增代码将放置在适当的包结构中。将严格遵循Spring Boot最佳实践和项目现有的代码风格约定。

## Definition of Done
- [ ] 所有验收标准通过测试
- [ ] 代码通过Code Review
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试全部通过
- [ ] API文档已更新并验证
- [ ] 性能测试满足要求 (< 500ms响应时间)
- [ ] 安全测试通过 (权限控制验证)
- [ ] OpenAPI规范完全符合

## Dependencies
- **前置依赖:** Story 1.1 (用户认证与授权系统) - 已完成
- **数据依赖:** Course数据模型需要预先创建或与Story并行开发
- **环境依赖:** PostgreSQL数据库配置就绪

## Risks and Mitigations
- **风险:** OpenAPI规范理解错误可能导致API不兼容
  - **缓解:** 仔细审查openapi.yaml文件，创建规范验证测试
- **风险:** 权限控制逻辑复杂，容易出现安全漏洞
  - **缓解:** 全面的安全测试，包括权限绕过测试
- **风险:** 分页查询性能问题
  - **缓解:** 数据库索引优化，查询性能基准测试
- **风险:** 业务规则验证逻辑复杂
  - **缓解:** 详细的单元测试覆盖所有边界条件

## Business Rules Summary
根据OpenAPI规范和架构文档，关键业务规则包括：
1. **创建权限:** 只有LECTURER可以创建工时记录
2. **课程权限:** LECTURER只能为自己负责的课程创建工时
3. **查看权限:** TUTOR只能查看自己的记录，ADMIN可查看所有
4. **日期规则:** weekStartDate必须是星期一
5. **数值范围:** hours(0.1-40), hourlyRate(10-200)
6. **唯一性:** 同一TUTOR+Course+WeekStartDate组合唯一
7. **状态管理:** 新创建的工时记录状态为DRAFT

---
**Created:** 2025-08-01  
**Last Updated:** 2025-08-01  
**Status:** Ready for Development