# Story 4.1: Centralized Authentication & Security Enhancement

## Story Information
- **Epic:** 4 - Authentication Security & System Hardening
- **Story:** 4.1
- **Title:** Centralized Authentication & Security Enhancement
- **Status:** Approved
- **Assigned to:** Development Agent
- **Story Points:** [To be estimated]

## Story Statement
**As a** system user (TUTOR, LECTURER, or ADMIN),
**I want** a secure, centralized authentication system with consistent token management and environment-specific security controls,
**so that** I can trust that my session data is protected, my authentication state is reliable across the application, and the system maintains security best practices in all deployment environments.

This story addresses critical authentication security vulnerabilities discovered through frontend analysis, including localStorage access pattern inconsistencies, API client duplication with divergent error handling, and production security leaks through environment detection inconsistencies.

## Acceptance Criteria
- **AC1:** All authentication token storage and retrieval operations must go through a single centralized `AuthManager` that uses `STORAGE_KEYS` constants consistently across all components
- **AC2:** Frontend authentication state must be synchronized with the API client token state automatically, ensuring logout/login operations update both contexts simultaneously  
- **AC3:** Environment detection for E2E testing must be unified across all components using a single `ENV_CONFIG` utility with consistent MODE checking logic
- **AC4:** Production builds must automatically filter out all debug logging, sensitive data exposure, and test-specific code using environment-aware logging and conditional compilation
- **AC5:** API client duplication must be eliminated by consolidating `useApi` hooks to use the centralized `ApiClient` with unified error handling and 401 response processing
- **AC6:** Authentication error handling must use React Router navigation instead of `window.location.href` redirects to maintain SPA experience
- **AC7:** All authentication-related configuration (ports, API endpoints, environment flags) must be centralized in a single configuration system with environment-specific variants

## Dev Notes

### Critical Frontend Issues Requiring Resolution

Based on comprehensive frontend analysis, the following critical authentication and security issues must be addressed:

**Authentication Token Management Issues**:
- Multiple direct localStorage access points bypass Single Source of Truth (SSOT) principle
- `services/api.ts:106-107` hardcodes storage keys instead of using `STORAGE_KEYS` constants [Source: frontend/src/utils/storage-keys.ts]
- `ApiClient` reads token once at module initialization, never syncs with AuthContext state changes
- No centralized auth state management causing potential inconsistencies between UI and API layers

**API Client Architecture Problems**:
- Duplicate API implementations: `useApi.ts` manual axios calls vs `ApiClient` singleton with interceptors
- Divergent error handling: `useApi` returns error messages only, `ApiClient` has comprehensive 401 handling with redirects
- No token synchronization between useApi hooks and ApiClient instance
- Performance impact from maintaining two separate HTTP client patterns

**Environment Detection Inconsistencies**:
- AuthContext checks: `MODE === 'test' && VITE_E2E_TEST === 'true'` [Source: frontend/src/contexts/AuthContext.tsx:60]
- ProtectedRoute checks: `MODE === 'e2e' && VITE_E2E_AUTH_BYPASS_ROLE` [Source: frontend/src/components/ProtectedRoute.tsx:18-29]
- main.tsx checks: `MODE === 'e2e'` [Source: frontend/src/main.tsx:37]
- Risk: E2E tests may randomly fail due to inconsistent auth bypass logic

**Production Security Exposures**:
- Unconditional sensitive data logging in `main.tsx:7-32` exposes token/user snapshots and test globals in production
- API request/error logging without environment filtering in `services/api.ts:65,86`
- No production filtering for debug information or test-specific code paths

**Configuration Architecture Fragmentation**:
- Three separate configuration sources with different defaults:
  - `src/config.ts` → API_BASE_URL (8084)
  - `src/config/api.config.ts` → API_CONFIG (8080 default, 8084 E2E)
  - `e2e/config/e2e.config.ts` → E2E_CONFIG (127.0.0.1:8084)
- Port drift: vite.config.ts uses 5174, some references still use 5173

### Architecture Integration Requirements

**Technology Stack Alignment** [Source: docs/architecture/tech-stack.md]:
- **Frontend Framework**: React.js with TypeScript for type safety
- **Authentication**: JWT Token authentication mechanism with BCrypt password encryption
- **Security**: Spring Security CSRF and XSS protection, HTTPS/TLS transport security
- **Data Validation**: Hibernate Validator for input validation

**Project Structure Compliance** [Source: docs/architecture/project-structure.md]:
- Frontend authentication utilities should follow established patterns
- Configuration files must maintain consistent structure and naming
- Security components should be properly organized and documented

**Coding Standards Compliance** [Source: docs/architecture/coding-standards.md]:
- Error handling must follow centralized exception handling patterns
- Security considerations must prevent information exposure
- Logging strategy must differentiate between development and production environments

### Technical Implementation Strategy

**1. Centralized Authentication Management**:
```typescript
// New: src/services/auth-manager.ts
export class AuthManager {
  private static instance: AuthManager;
  private listeners: Set<(state: AuthState) => void> = new Set();
  
  setAuth(token: string, user: User): void {
    // Update internal state
    // Persist to storage using STORAGE_KEYS
    // Sync with ApiClient.setAuthToken()
    // Notify all listeners
  }
  
  clearAuth(): void {
    // Clear internal state
    // Clear storage using STORAGE_KEYS  
    // Clear ApiClient token
    // Notify listeners
  }
}
```

**2. Unified Environment Detection**:
```typescript
// New: src/utils/environment.ts
export const ENV_CONFIG = {
  isE2E: () => import.meta?.env?.MODE === 'e2e',
  e2e: {
    hasAuthBypass: () => ENV_CONFIG.isE2E() && Boolean(import.meta?.env?.VITE_E2E_AUTH_BYPASS_ROLE),
    getBypassRole: () => import.meta?.env?.VITE_E2E_AUTH_BYPASS_ROLE
  }
} as const;
```

**3. Production Security Layer**:
```typescript
// New: src/utils/secure-logger.ts
export const secureLogger = {
  debug: (message: string, data?: any) => {
    if (!ENV_CONFIG.isProduction()) {
      console.debug(message, data);
    }
  },
  error: (message: string, error: any) => {
    if (ENV_CONFIG.isProduction()) {
      // Production: Log without sensitive details
      console.error(message, { timestamp: new Date().toISOString(), type: error?.name });
    } else {
      console.error(message, error);
    }
  }
};
```

**4. API Client Consolidation**:
```typescript
// Enhanced: src/services/api.ts
class ApiClient {
  constructor() {
    // Register for auth state changes from AuthManager
    AuthManager.getInstance().subscribe((state) => {
      this.setAuthToken(state.token);
    });
  }
  
  private handleAuthError(): void {
    // Use centralized auth manager
    AuthManager.getInstance().clearAuth();
    // Use React Router navigation instead of window.location
    if (window.__APP_NAVIGATE__) {
      window.__APP_NAVIGATE__('/login', { replace: true });
    }
  }
}

// Replace useApi hooks with ApiClient-based implementations
export const useApiClient = () => useMemo(() => apiClient, []);
```

**5. Unified Configuration System**:
```typescript
// New: src/config/unified-config.ts
interface AppConfig {
  api: { baseUrl: string; timeout: number; };
  frontend: { port: number; url: string; };
  features: { msw: boolean; authBypass: boolean; detailedLogging: boolean; };
}

export const getConfig = (): AppConfig => {
  const mode = import.meta?.env?.MODE;
  switch (mode) {
    case 'e2e': return E2E_CONFIG;
    case 'development': return DEV_CONFIG;
    case 'production': return PROD_CONFIG;
    default: return DEV_CONFIG;
  }
};
```

### Security Requirements

**Authentication Security** [Source: docs/prd-v0.2.md sections 5.2.1-5.2.2]:
- JWT Token validity period not exceeding 8 hours with automatic renewal support
- Role-based access control (RBAC) ensuring users access only authorized resources
- Password policy: 8+ characters with uppercase, lowercase, numbers, and special characters
- Data encryption for sensitive information in storage

**Data Protection**:
- HTTPS/TLS transport layer security for all API communication
- Input validation on both frontend and backend to prevent injection attacks
- XSS protection through HTML escaping of output content
- CSRF protection implementation

**Privacy Protection**:
- Data minimization: collect and store only necessary business data
- Access logs for sensitive data audit purposes
- Data anonymization in non-production environments

### Error Handling Strategy

**Centralized Error Processing**:
- All authentication errors must bubble up to global error handlers
- Business exceptions vs system exceptions differentiation
- Standardized error response format with appropriate HTTP status codes
- Security-conscious error messages that don't expose system internals

## Tasks/Subtasks

### Task 1: Implement Centralized Authentication Manager (AC1, AC2)
- [x] Create `src/services/auth-manager.ts` with singleton pattern and listener management
- [x] Implement `setAuth()` method that updates state, persists using STORAGE_KEYS, and syncs with ApiClient
- [x] Implement `clearAuth()` method that clears all auth state consistently
- [x] Add state subscription mechanism for component updates
- [x] Create `src/types/auth.ts` for TypeScript type definitions
- [x] Update AuthContext to use AuthManager instead of direct localStorage access
- [x] Add comprehensive unit tests for AuthManager singleton behavior

### Task 2: Unify Environment Detection Logic (AC3)
- [x] Create `src/utils/environment.ts` with centralized ENV_CONFIG
- [x] Implement consistent E2E detection: `MODE === 'e2e'` everywhere
- [x] Update AuthContext to use ENV_CONFIG instead of hardcoded checks
- [x] Update ProtectedRoute to use ENV_CONFIG for bypass logic
- [x] Update main.tsx to use ENV_CONFIG for MSW initialization
- [x] Remove all hardcoded environment detection patterns
- [x] Add unit tests for environment detection logic

### Task 3: Implement Production Security Layer (AC4)
- [ ] Create `src/utils/secure-logger.ts` with environment-aware logging
- [ ] Update main.tsx to conditionally expose E2E globals only in E2E mode
- [ ] Update ApiClient to use secure logger instead of direct console calls
- [ ] Implement conditional compilation for test-specific code paths
- [ ] Add production build validation to ensure no sensitive data exposure
- [ ] Create security unit tests for logging and data exposure

### Task 4: Consolidate API Client Architecture (AC5, AC6)
- [ ] Enhance ApiClient constructor to subscribe to AuthManager state changes
- [ ] Update ApiClient.handleAuthError() to use React Router navigation
- [ ] Create ApiClient-based replacement hooks for useApi functionality
- [ ] Update all components using useApi to use new ApiClient hooks
- [ ] Remove original useApi.ts implementation after migration
- [ ] Add React Router navigation injection mechanism for ApiClient
- [ ] Add integration tests for API client auth synchronization

### Task 5: Create Unified Configuration System (AC7)
- [ ] Create `src/config/unified-config.ts` with environment-based configuration loading
- [ ] Define TypedConfig interface for all application configuration
- [ ] Implement getConfig() function with mode-based configuration selection
- [ ] Update all components to use unified configuration instead of scattered configs
- [ ] Deprecate `src/config.ts` and `src/config/api.config.ts` after migration
- [ ] Update Vite configuration and E2E configuration to use unified system
- [ ] Add configuration validation and unit tests

### Task 6: Security Hardening and Validation (AC1-AC7)
- [ ] Implement input validation for all authentication-related data
- [ ] Add CSRF token handling if required by backend
- [ ] Implement secure session management with automatic token refresh
- [ ] Add security headers configuration and validation
- [ ] Create security audit logging for authentication events
- [ ] Add penetration testing scenarios for authentication flows
- [ ] Document security implementation and best practices

### Task 7: Integration Testing and Verification (AC1-AC7)
- [ ] Create AuthManager integration tests with ApiClient synchronization
- [ ] Test environment detection consistency across all components
- [ ] Verify production security filtering in build pipeline
- [ ] Test unified API client behavior across all authentication scenarios
- [ ] Validate configuration loading in all environment modes
- [ ] Create end-to-end authentication flow tests
- [ ] Verify backward compatibility and migration completeness

### Task 8: Documentation and Migration Guide
- [ ] Create migration guide for components using old authentication patterns
- [ ] Update API documentation to reflect unified authentication approach
- [ ] Document new environment detection and configuration patterns
- [ ] Create security best practices guide for future development
- [ ] Update component documentation with new authentication usage patterns
- [ ] Create troubleshooting guide for authentication issues

## Testing

### Testing Standards
Following established project testing patterns [Source: docs/architecture/coding-standards.md]:
- **Unit Tests**: Service layer methods with 80%+ coverage using Jest/Vitest
- **Integration Tests**: Full authentication flow testing with realistic scenarios
- **Security Tests**: Authentication security and data protection validation
- **E2E Tests**: Cross-environment authentication consistency validation

### Test File Structure
```
src/test/
├── services/
│   ├── auth-manager.test.ts [New]
│   └── api-client-auth-sync.test.ts [New]
├── utils/
│   ├── environment.test.ts [New]
│   └── secure-logger.test.ts [New]
├── config/
│   └── unified-config.test.ts [New]
├── integration/
│   ├── auth-flow-integration.test.ts [New]
│   └── environment-consistency.test.ts [New]
└── security/
    ├── auth-security.test.ts [New]
    └── production-security.test.ts [New]
```

### Key Test Scenarios
- **Authentication State Synchronization**: AuthManager and ApiClient token consistency
- **Environment Detection**: Consistent behavior across all components in different modes
- **Security Filtering**: Production builds properly filter sensitive information
- **Error Handling**: Proper error propagation and user experience
- **Configuration Loading**: Correct configuration selection in all environments

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-20 | 1.0 | Initial story creation addressing critical frontend authentication security issues | Scrum Master (SuperClaude) |

## Dev Agent Record
**Agent Model Used:** Claude 4 Sonnet  
**Implementation Started:** 2025-08-20

### Implementation Status
- [x] Task 1: Implement Centralized Authentication Manager
- [x] Task 2: Unify Environment Detection Logic
- [ ] Task 3: Implement Production Security Layer
- [ ] Task 4: Consolidate API Client Architecture
- [ ] Task 5: Create Unified Configuration System
- [ ] Task 6: Security Hardening and Validation
- [ ] Task 7: Integration Testing and Verification
- [ ] Task 8: Documentation and Migration Guide

### File List
**New Files Created**:
- `src/services/auth-manager.ts` - Centralized authentication manager with singleton pattern
- `src/types/auth.ts` - TypeScript type definitions for authentication
- `src/utils/environment.ts` - Centralized environment detection utility with ENV_CONFIG
- `src/test/services/auth-manager.test.ts` - Comprehensive unit tests for AuthManager
- `src/test/utils/environment.test.ts` - Unit tests for environment detection logic

**Modified Files**:
- `src/contexts/AuthContext.tsx` - Updated to use AuthManager and ENV_CONFIG for E2E detection
- `src/components/ProtectedRoute.tsx` - Updated to use ENV_CONFIG for bypass logic
- `src/main.tsx` - Updated to use ENV_CONFIG for MSW initialization and debug logging
- `src/config/api.config.ts` - Updated to use ENV_CONFIG for E2E detection

### Completion Notes
**Task 1 - Centralized Authentication Manager**: ✅ COMPLETED
- Successfully implemented singleton AuthManager with full SSOT compliance
- All authentication operations now use STORAGE_KEYS consistently  
- Token synchronization mechanism established for API client integration
- State subscription system implemented for component updates
- Comprehensive test suite with 22 passing tests covering all scenarios
- AuthContext updated to delegate to AuthManager while preserving E2E bypass logic

**Task 2 - Unify Environment Detection Logic**: ✅ COMPLETED
- Created centralized ENV_CONFIG utility with comprehensive environment detection
- Implemented consistent E2E detection across all components using `ENV_CONFIG.isE2E()`
- Updated AuthContext to use ENV_CONFIG.e2e.hasAuthBypass() instead of hardcoded checks
- Updated ProtectedRoute to use ENV_CONFIG.e2e.hasAuthBypass() for bypass logic
- Updated main.tsx to use ENV_CONFIG for MSW initialization and debug logging
- Updated api.config.ts to use ENV_CONFIG for E2E detection
- Removed all hardcoded import.meta.env.MODE and VITE_E2E_* patterns
- Added comprehensive test suite with 17 passing tests for environment detection
- Enhanced production security with environment-aware logging and debug exposure

## QA Results
*This section will be populated by the QA Agent after story completion*

---
**Created:** 2025-08-20  
**Last Updated:** 2025-08-20  
**Status:** Draft